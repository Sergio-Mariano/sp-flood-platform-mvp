<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enchentes SP â€” Mapa</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --brand:#22d3ee;
      --btn:#1f2937; --btnHover:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;
      padding:16px 20px;background:linear-gradient(90deg,#0ea5e922,#06b6d422);
      border-bottom:1px solid #1f2937;
    }
    h1{margin:0;font-size:1.25rem;letter-spacing:.3px}
    .pill{display:flex;align-items:center;gap:.4rem;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:.35rem .6rem}
    select,button{
      background:var(--btn);color:var(--text);border:1px solid #1f2937;border-radius:10px;
      padding:.5rem .7rem;font-size:.95rem;cursor:pointer
    }
    button:hover{background:var(--btnHover)}
    .brand{color:var(--brand);font-weight:600}
    .spacer{flex:1}
    #status{padding:8px 20px;color:var(--muted);border-bottom:1px solid #1f2937}
    #map{height:78vh;border-top:1px solid #1f2937}
    .drop-icon{font-size:22px;line-height:22px;text-align:center;pointer-events:auto}
    .spinner{width:14px;height:14px;border:2px solid #94a3b8;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{opacity:.8}
  </style>
</head>
<body>
<header>
  <h1>ðŸ’§ <span class="brand">Enchentes SP</span> â€” Mapa</h1>

  <div class="pill">
    <label for="days">PerÃ­odo</label>
    <select id="days">
      <option value="7">7 dias</option>
      <option value="30">30 dias</option>
      <option value="90" selected>90 dias</option>
      <option value="0">Todos</option>
    </select>
  </div>

  <div class="pill">
    <label for="limit">Limite</label>
    <select id="limit">
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200" selected>200</option>
      <option value="500">500</option>
    </select>
  </div>

  <div class="spacer"></div>

  <button id="btnRefresh" title="Buscar do GeoSampa e desenhar no mapa">Atualizar mapa</button>
  <button id="btnIngest" title="(Opcional) Ingerir no banco, se o endpoint existir">Ingerir & atualizar</button>
</header>

<div id="status" class="hint">Pronto. Clique em <b>Atualizar mapa</b> para carregar.</div>
<div id="map"></div>

<script>
const statusEl = document.getElementById('status');
const btnRefresh = document.getElementById('btnRefresh');
const btnIngest = document.getElementById('btnIngest');
const selDays = document.getElementById('days');
const selLimit = document.getElementById('limit');

const map = L.map('map').setView([-23.55, -46.64], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);

const dropIcon = L.divIcon({ className:'drop-icon', html:'ðŸ’§', iconSize:[22,22], iconAnchor:[11,16], popupAnchor:[0,-14]});
let layer = null;

function setStatus(msg, loading=false){
  statusEl.innerHTML = loading ? `<span class="spinner"></span> ${msg}` : msg;
}
function enableUI(en=true){ btnRefresh.disabled=btnIngest.disabled = !en; selDays.disabled=selLimit.disabled = !en; }

async function fetchGeo(limit, days){
  const url = `/floods/geosampa?limit=${encodeURIComponent(limit)}&days=${encodeURIComponent(days)}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`Falha ao carregar ${url} (HTTP ${res.status})`);
  return await res.json();
}
function renderGeoJSON(gj){
  if (layer){ map.removeLayer(layer); layer = null; }
  layer = L.geoJSON(gj, {
    pointToLayer: (f, latlng) => L.marker(latlng, { icon: dropIcon }),
    onEachFeature: (f, l) => {
      const p = f?.properties || {};
      const tipo  = p.dc_tipo_ocorrencia || p.event_type || 'alagamento';
      const sub   = p.nm_subprefeitura   || p.subprefeitura || 'â€”';
      const data  = p.dt_ocorrencia      || p.dt_carga      || p.data || p.timestamp || 'â€”';
      const fonte = p.sg_fonte_original  || p.source || 'GeoSampa';
      l.bindPopup(`<b>Tipo:</b> ${tipo}<br><b>Subprefeitura:</b> ${sub}<br><b>Data:</b> ${data}<br><b>Fonte:</b> ${fonte}`);
    }
  }).addTo(map);

  if (layer.getBounds && layer.getBounds().isValid()){
    map.fitBounds(layer.getBounds(), { padding:[20,20] });
  }
}
async function refreshOnly(){
  try{
    enableUI(false); setStatus('Carregando do GeoSampaâ€¦', true);
    const limit = Number(selLimit.value), days = Number(selDays.value);
    const gj = await fetchGeo(limit, days);
    const n = (gj.features||[]).length;
    renderGeoJSON(gj);
    setStatus(`Pontos recebidos: ${n} (limit=${limit}, days=${days})`);
  }catch(e){
    console.error(e); setStatus('Falha ao atualizar mapa. Veja o Console (F12).');
  }finally{ enableUI(true); }
}
async function ingestAndRefresh(){
  try{
    enableUI(false); setStatus('Ingerindo do GeoSampa para o bancoâ€¦', true);
    // tenta chamar /ingest/geosampa; se nÃ£o existir, ignora e sÃ³ recarrega
    try{
      const resp = await fetch('/ingest/geosampa', { method:'POST' });
      if (!resp.ok) throw new Error('POST /ingest/geosampa falhou');
      await resp.json();
    }catch(e){
      console.warn('Ingest nÃ£o disponÃ­vel? Prosseguindo sÃ³ com refresh.', e);
    }
    await refreshOnly();
  }finally{ enableUI(true); }
}

btnRefresh.addEventListener('click', refreshOnly);
btnIngest.addEventListener('click', ingestAndRefresh);
selDays.addEventListener('change', refreshOnly);
selLimit.addEventListener('change', refreshOnly);

// carregamento inicial opcional:
refreshOnly();
</script>
</body>
</html>
